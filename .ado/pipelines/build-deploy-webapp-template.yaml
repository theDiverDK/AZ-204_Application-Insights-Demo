parameters:
  - name: webAppName
    type: string

  - name: appServiceName
    type: string
  
  - name: appType
    type: string
  
  - name: azureServiceConnectionName
    type: string

steps:
  - task: DotNetCoreCLI@2
    displayName: 'Restore Nuget Packages'
    inputs:
      command: 'restore'
      projects: $(System.DefaultWorkingDirectory)/src/WebApps/${{ parameters.webAppName }}/*.csproj
      feedsToUse: 'select'

  - task: DotNetCoreCLI@2
    displayName: 'Build and Publish'
    inputs:
      command: 'publish'
      projects: $(System.DefaultWorkingDirectory)/src/WebApps/${{ parameters.webAppName }}/*.csproj
      publishWebProjects: false
      arguments: "-o $(Build.ArtifactStagingDirectory) --configuration Release"

  - task: PublishPipelineArtifact@1
    displayName: 'Publish artifact'
    inputs:
      targetPath: "$(Build.ArtifactStagingDirectory)"
      artifact: ${{ parameters.appServiceName }}
      publishLocation: "pipeline"

  - script: |
          echo "webAppName: ${{ parameters.webAppName }}"
          echo "appServiceName: ${{ parameters.appServiceName }}"
          echo "appType: ${{ parameters.appType }}"
          echo "azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}"
          echo "targetPath: $(Build.ArtifactStagingDirectory)"
          echo "artifact: ${{ parameters.appServiceName }}"
          
    displayName: 'Print variables using Bash from build-deploy-webapp-template.yaml'

  - template: deploy-webapp-template.yaml
    parameters:
      webAppName: ${{ parameters.webAppName }}
      appServiceName: ${{ parameters.appServiceName }}
      appType: ${{ parameters.appType }}
      azureServiceConnectionName: ${{ parameters.azureServiceConnectionName }}
